<!DOCTYPE html>
<html>
<head>
    <title>Milestones by Release</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Wed May 10 2017 08:46:53 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Wed May 10 2017 08:46:53 GMT-0600 (MDT)";
        var STORY    = "F208";
        var BUILDER  = "corkr03";
        var CHECKSUM = 5918543184;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("cats-milestone-by-release.utils.MilestonesTemplate",{extend:"Ext.XTemplate",constructor:function(a){a=a||{};var b=['<tpl for=".">',"{[this.getPillHtml(values)]}","</tpl>",{getPillHtml:this.getPillHtml},a];return this.callParent(b)},getPillHtml:function(a){var b=a.DisplayColor?' style="color: '+a.DisplayColor+';"':"",c=this.iconCls?'<span class="'+this.iconCls+'"'+b+"></span>":"",d=a.TargetDate&&Rally.util.DateTime.formatWithDefault(Rally.util.DateTime.fromIsoString(a.TargetDate))||"";return console.log("targetDate",d,a),'<span class="'+(this.cls?this.cls:"")+'">'+c+a.Name+"<br/><b>"+d+"</b></span>"},apply:function(a,b){var c=this._transformValues(a);return this.callParent([c,b])},_transformValues:function(a){var b=a[this.collectionName];return b=b._tagsNameArray?b._tagsNameArray?b._tagsNameArray:b:_.isArray(b)?_.map(b,function(a){var b=a.TargetDate||a.get("TargetDate");return b&&(b=Rally.util.DateTime.fromIsoString(b)),{_ref:a._ref||a.get("_ref"),Name:a.Name||a.get("Name"),TargetDate:b,DisplayColor:a.DisplayColor||a.get("DisplayColor")}}):[],b=Rally.util.Array.sortByAttribute(b,"TargetDate")}}),Ext.define("cats-milestone-by-release",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"cats-milestone-by-release"},portfolioItemTypes:[],portfolioItemRecordsByType:{},launch:function(){return this.removeAll(),this.getContext().getTimeboxScope()&&"release"===this.getContext().getTimeboxScope().getType()?void this._fetchPortfolioItemTypes().then({success:this._initializeApp,failure:this._showAppError,scope:this}):void this._addAppMessage("This app is designed to run on a release scoped dashboard.")},_initializeApp:function(a){this.logger.log("_initializeApp",a),this.portfolioItemTypes=Ext.Array.map(a,function(a){return a.get("TypePath")}),this.onTimeboxScopeChange(this.getContext().getTimeboxScope())},_showAppError:function(a){this.add({xtype:"container",itemId:"errorMessage",html:Ext.String.format('<div class="no-data-container"><div class="primary-message">{0}</div></div>',a)})},_addAppMessage:function(a){this.add({xtype:"container",itemId:"appMessage",html:Ext.String.format('<div class="no-data-container"><div class="primary-message">{0}</div></div>',a)})},_clearWindow:function(){this.down("#appMessage")&&this.down("#appMessage").destroy(),this.down("rallygrid")&&this.down("rallygrid").destroy()},onTimeboxScopeChange:function(a){this.getContext().setTimeboxScope(a),this.logger.log("onTimeboxScopeChange",a,a.getRecord()),this._clearWindow(),a&&"release"===a.getType()?a.getRecord()?this._updateDisplay(a):this._addAppMessage("Please select a release to see portfolio milestones for that timebox."):this._addAppMessage("This app is designed to run on a dashboard with a Release timebox selector.")},_buildStore:function(a){this.logger.log("_buildStore",a);var b=[];Ext.Object.each(a[this.portfolioItemTypes[0].toLowerCase()],function(c,d){var e=this._getMilestones(d,a),f=d;f.Milestones=e,b.push(f)},this),this.logger.log("_buildStore",b);var c=Ext.create("Rally.data.custom.Store",{data:b,fields:["FormattedID","Name","Milestones","_ref","_type"],pageSize:b.length});this._addGrid(c)},_addGrid:function(a){this.down("rallygrid")&&this.down("rallygrid").destroy(),this.add({xtype:"rallygrid",store:a,columnCfgs:this._getColumnCfgs(),showRowActionsColumn:!1,showPagingToolbar:!1})},_getColumnCfgs:function(){return[{dataIndex:"FormattedID",text:"ID",renderer:function(a,b,c){return Ext.create("Rally.ui.renderer.template.FormattedIDTemplate").apply(c.data)}},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"Milestones",text:"Milestones",flex:1,renderer:function(a,b,c){return Ext.create("cats-milestone-by-release.utils.MilestonesTemplate",{collectionName:"Milestones",iconCls:"icon-milestone",cls:"milestone-pill"}).apply(c.getData())}}]},_getMilestones:function(a,b){var c=a._type&&a._type.toLowerCase(),d=b[c][a.ObjectID],e=this.getContext().getTimeboxScope().getRecord().get("ReleaseStartDate"),f=this.getContext().getTimeboxScope().getRecord().get("ReleaseDate"),g=[];d&&d.Milestones&&d.Milestones._tagsNameArray&&d.Milestones._tagsNameArray.length>0&&Ext.Array.each(d.Milestones._tagsNameArray,function(a){var b=a.TargetDate&&Rally.util.DateTime.fromIsoString(a.TargetDate);b>=e&&f>=b&&g.push(a)});var h=d&&d.Parent||null;return h?g.concat(this._getMilestones(h,b)):_.uniq(g)},_getFeatureFilters:function(a){var b=[],c=["Milestones","ObjectID"];if(null===a.getRecord())Ext.Array.each(this.portfolioItemTypes,function(a){b.push({property:c.join("."),operator:">",value:0}),c.unshift("Parent")}),b=Rally.data.wsapi.Filter.or(b);else{var d=Rally.util.DateTime.toIsoString(a.getRecord().get("ReleaseStartDate")),e=Rally.util.DateTime.toIsoString(a.getRecord().get("ReleaseDate"));c=["Milestones","TargetDate"],Ext.Array.each(this.portfolioItemTypes,function(a){var f=[{property:c.join("."),operator:">=",value:d},{property:c.join("."),operator:"<=",value:e}];b.push(Rally.data.wsapi.Filter.and(f)),c.unshift("Parent")}),b=Rally.data.wsapi.Filter.or(b)}return b=b.and(a.getQueryFilter()),this.logger.log("_getFeatureFilters",b.toString()),b},_updateDisplay:function(a){this.logger.log("_updateDisplay",a.getQueryFilter());var b=this._getFeatureFilters(a);this.portfolioItemRecordsByType={},this._fetchWsapiRecords({model:this.portfolioItemTypes[0],fetch:["FormattedID","ObjectID","Name","Milestones","Parent","TargetDate"],filters:b}).then({success:this._fetchAncestors,failure:this._showAppError,scope:this})},_getPortfolioItemTypeOrdinal:function(a){for(var b=0;b<this.portfolioItemTypes.length;b++)if(this.portfolioItemTypes[b].toLowerCase()===a.toLowerCase())return b;return b},_fetchAncestors:function(a){var b=this.portfolioItemTypes.length;a&&a.length>0&&(b=this._getPortfolioItemTypeOrdinal(a[0].get("_type")));var c=this._getUniqueParentOids(a);if(this.logger.log("_fetchAncestors",b,a,c),this.portfolioItemRecordsByType=_.reduce(a,function(a,b){return a[b.get("_type")]||(a[b.get("_type")]={}),a[b.get("_type")][b.get("ObjectID")]=b.getData(),a},this.portfolioItemRecordsByType),b+1===this.portfolioItemTypes.length||0===c.length)return void this._buildStore(this.portfolioItemRecordsByType);var d=Ext.Array.map(c,function(a){return{property:"ObjectID",value:a}});c.length>1&&(d=Rally.data.wsapi.Filter.or(d)),this._fetchWsapiRecords({model:this.portfolioItemTypes[b+1],fetch:["FormattedID","ObjectID","Name","Milestones","Parent","TargetDate"],filters:d,context:{project:null}}).then({success:this._fetchAncestors,failure:this._showAppError,scope:this})},_getUniqueParentOids:function(a){this.logger.log("_getUniqueParentOids",a);for(var b=[],c=0;c<a.length;c++)a[c].get("Parent")&&b.push(a[c].get("Parent").ObjectID);return Ext.Array.unique(b)},_fetchPortfolioItemTypes:function(){return this._fetchWsapiRecords({model:"TypeDefinition",fetch:["Name","TypePath","Ordinal"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]})},_fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred"),c=this;return a.limit||(a.limit="Infinity"),a.pageSize||(a.pageSize=2e3),this.logger.log("Starting load:",a),Ext.create("Rally.data.wsapi.Store",a).load({callback:function(a,d,e){e?b.resolve(a):(c.logger.log("Failed: ",d),b.reject("Problem fetching: "+d.error.errors.join(". ")))}}),b.promise},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})}});
            
               Rally.launchApp('cats-milestone-by-release', {
                   name: 'Milestones by Release'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.appMessage {
  color: #222;
  font-family: ProximaNova, Helvetica, Arial;
  font-size: 18px;
  text-align: center;
}
.errorMessage {
  color: #B81B10;
  font-family: ProximaNova, Helvetica, Arial;
  font-size: 18px;
  text-align: center;
}

    </style>

</head>
<body></body>
</html>